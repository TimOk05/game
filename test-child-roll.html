<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Child Roll</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .success {
            background: #d4edda;
            border-color: #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            border-color: #f5c6cb;
        }
        
        .info {
            background: #d1ecf1;
            border-color: #bee5eb;
        }
        
        button {
            padding: 10px 15px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
        
        .event-result {
            background: #f8f9fa;
            padding: 10px;
            margin: 5px 0;
            border-radius: 3px;
            border-left: 4px solid #007bff;
        }
        
        .child-event {
            border-left-color: #28a745;
        }
        
        .parent-event {
            border-left-color: #ffc107;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin: 10px 0;
        }
        
        .stat {
            background: #e9ecef;
            padding: 5px 10px;
            border-radius: 3px;
        }
    </style>
</head>

<body>
    <h1>üé≤ Test Child Roll Mechanics</h1>

    <div class="test-section">
        <h2>üìã Tavern Events Test</h2>
        <button onclick="testTavernEvents()">Test Tavern Child Roll</button>
        <div id="tavern-results"></div>
    </div>

    <div class="test-section">
        <h2>üîÑ Multiple Tests</h2>
        <button onclick="runMultipleTests()">Run 10 Child Roll Tests</button>
        <div id="multiple-results"></div>
    </div>

    <div class="test-section">
        <h2>üìä Statistics</h2>
        <button onclick="showStatistics()">Show Child Roll Statistics</button>
        <div id="stats-results"></div>
    </div>

    <script>
        async function testTavernEvents() {
            const results = document.getElementById('tavern-results');
            results.innerHTML = '<p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π —Ç–∞–≤–µ—Ä–Ω—ã...</p>';

            let html = '<h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤ —Ç–∞–≤–µ—Ä–Ω—ã:</h3>';

            try {
                // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –¥–µ—Ä–µ–≤–Ω–∏
                const state = {
                    location: "village",
                    turn: 1,
                    seenIds: [],
                    cooldowns: {},
                    stats: {
                        hp: 20,
                        damage: 3,
                        fame: 0,
                        gold: 10,
                        items: []
                    }
                };

                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–æ–±—ã—Ç–∏–µ —Ç–∞–≤–µ—Ä–Ω—ã
                const response = await fetch('/api/next.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        state
                    })
                });

                const result = await response.json();

                if (result.success) {
                    const event = result.data.event;
                    const meta = event.meta || {};

                    html += `<div class="event-result ${meta.was_child_roll ? 'child-event' : 'parent-event'}">
                        <h4>${meta.was_child_roll ? 'üé≤ Child Event' : 'üìã Base Event'}</h4>
                        <strong>${event.title}</strong><br>
                        <em>ID: ${event.id}</em><br>
                        <strong>Effects:</strong> ${JSON.stringify(event.effects)}<br>
                        <small>
                            Child Roll: ${meta.was_child_roll ? 'Yes' : 'No'} | 
                            Original: ${meta.original_event_id || 'N/A'} | 
                            Child: ${meta.child_event_id || 'N/A'}
                        </small>
                    </div>`;

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                    html += `<div class="stats">
                        <div class="stat">HP: ${result.data.state.stats.hp}</div>
                        <div class="stat">Gold: ${result.data.state.stats.gold}</div>
                        <div class="stat">Fame: ${result.data.state.stats.fame}</div>
                        <div class="stat">Turn: ${result.data.state.turn}</div>
                    </div>`;

                } else {
                    html += `<div class="error">‚ùå Error: ${result.error}</div>`;
                }

            } catch (error) {
                html += `<div class="error">‚ùå Network Error: ${error.message}</div>`;
            }

            results.innerHTML = html;
        }

        async function runMultipleTests() {
            const results = document.getElementById('multiple-results');
            results.innerHTML = '<p>–ó–∞–ø—É—Å–∫ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤...</p>';

            let html = '<h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã 10 —Ç–µ—Å—Ç–æ–≤:</h3>';

            const testResults = {
                childRolls: 0,
                baseEvents: 0,
                events: []
            };

            for (let i = 0; i < 10; i++) {
                try {
                    const state = {
                        location: "village",
                        turn: i + 1,
                        seenIds: [],
                        cooldowns: {},
                        stats: {
                            hp: 20,
                            damage: 3,
                            fame: 0,
                            gold: 10,
                            items: []
                        }
                    };

                    const response = await fetch('/api/next.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            state
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        const event = result.data.event;
                        const meta = event.meta || {};

                        if (meta.was_child_roll) {
                            testResults.childRolls++;
                        } else {
                            testResults.baseEvents++;
                        }

                        testResults.events.push({
                            id: event.id,
                            title: event.title,
                            wasChildRoll: meta.was_child_roll,
                            originalId: meta.original_event_id,
                            effects: event.effects
                        });

                        html += `<div class="event-result ${meta.was_child_roll ? 'child-event' : 'parent-event'}">
                            <strong>Test ${i + 1}:</strong> ${event.title} 
                            ${meta.was_child_roll ? '(üé≤ Child)' : '(üìã Base)'}
                        </div>`;
                    }

                } catch (error) {
                    html += `<div class="error">Test ${i + 1} failed: ${error.message}</div>`;
                }
            }

            html += `<div class="info">
                <h4>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</h4>
                <p>Child Rolls: ${testResults.childRolls}/10 (${(testResults.childRolls/10*100).toFixed(1)}%)</p>
                <p>Base Events: ${testResults.baseEvents}/10 (${(testResults.baseEvents/10*100).toFixed(1)}%)</p>
            </div>`;

            results.innerHTML = html;
        }

        async function showStatistics() {
            const results = document.getElementById('stats-results');
            results.innerHTML = '<p>–ê–Ω–∞–ª–∏–∑ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</p>';

            let html = '<h3>üìä –ê–Ω–∞–ª–∏–∑ Child Roll –º–µ—Ö–∞–Ω–∏–∫–∏:</h3>';

            try {
                // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ–±—ã—Ç–∏—è—Ö —Ç–∞–≤–µ—Ä–Ω—ã
                const listResponse = await fetch('/api/list.php?type=village');
                const listData = await listResponse.json();

                if (listData.success) {
                    const tavernEvents = listData.data.events.filter(e => e.id.includes('tavern'));

                    html += '<h4>üé™ –°–æ–±—ã—Ç–∏—è —Ç–∞–≤–µ—Ä–Ω—ã:</h4>';
                    tavernEvents.forEach(event => {
                        html += `<div class="event-result">
                            <strong>${event.id}</strong><br>
                            <em>${event.title}</em><br>
                            <small>Rules: ${JSON.stringify(event.rules)}</small>
                        </div>`;
                    });

                    // –¢–µ—Å—Ç–∏—Ä—É–µ–º –±–∞–∑–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ —Ç–∞–≤–µ—Ä–Ω—ã
                    const tavernResponse = await fetch('/api/get.php?id=village.tavern');
                    const tavernData = await tavernResponse.json();

                    if (tavernData.success) {
                        const tavern = tavernData.data;
                        html += '<h4>üè† –ë–∞–∑–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ —Ç–∞–≤–µ—Ä–Ω—ã:</h4>';
                        html += `<div class="event-result parent-event">
                            <strong>${tavern.title}</strong><br>
                            <em>Child Roll Pool: ${JSON.stringify(tavern.rules.child_roll?.pool || [])}</em><br>
                            <em>Child Roll Chance: ${tavern.rules.child_roll?.chance || 'N/A'}</em>
                        </div>`;
                    }

                } else {
                    html += `<div class="error">‚ùå Error loading events: ${listData.error}</div>`;
                }

            } catch (error) {
                html += `<div class="error">‚ùå Error: ${error.message}</div>`;
            }

            results.innerHTML = html;
        }
    </script>
</body>

</html>