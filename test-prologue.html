<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Prologue</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .success {
            background: #d4edda;
            border-color: #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            border-color: #f5c6cb;
        }
        
        button {
            padding: 10px 15px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
        
        .event-preview {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
    </style>
</head>

<body>
    <h1>üé≠ Test Prologue Sequence</h1>

    <div class="test-section">
        <h2>üìã Prologue Events</h2>
        <button onclick="testPrologueEvents()">Load Prologue Events</button>
        <div id="prologue-results"></div>
    </div>

    <div class="test-section">
        <h2>üîÑ Sequence Test</h2>
        <button onclick="testEventSequence()">Test Event Sequence</button>
        <div id="sequence-results"></div>
    </div>

    <div class="test-section">
        <h2>üöÄ Full Game Test</h2>
        <p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –æ—Ç –ø—Ä–æ–ª–æ–≥–∞ –¥–æ –¥–µ—Ä–µ–≤–Ω–∏:</p>
        <button onclick="window.open('/public/index.html', '_blank')">üéØ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
    </div>

    <script>
        async function testPrologueEvents() {
            const results = document.getElementById('prologue-results');
            results.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π –ø—Ä–æ–ª–æ–≥–∞...</p>';

            let html = '<h3>–°–æ–±—ã—Ç–∏—è –ø—Ä–æ–ª–æ–≥–∞:</h3>';

            const prologueEvents = [
                'main.prologue.001',
                'main.prologue.002',
                'main.prologue.003',
                'main.prologue.004',
                'main.prologue.end'
            ];

            for (const eventId of prologueEvents) {
                try {
                    const response = await fetch(`/api/get.php?id=${eventId}`);
                    const data = await response.json();

                    if (data.success) {
                        html += `<div class="event-preview success">
                            <h4>‚úÖ ${eventId}</h4>
                            <strong>${data.data.title}</strong><br>
                            <em>${data.data.text.substring(0, 100)}...</em><br>
                            <small>Choices: ${data.data.choices.length} | Once: ${data.data.rules.once}</small>
                        </div>`;
                    } else {
                        html += `<div class="event-preview error">
                            <h4>‚ùå ${eventId}</h4>
                            <strong>Error:</strong> ${data.error}
                        </div>`;
                    }
                } catch (error) {
                    html += `<div class="event-preview error">
                        <h4>‚ùå ${eventId}</h4>
                        <strong>Network Error:</strong> ${error.message}
                    </div>`;
                }
            }

            results.innerHTML = html;
        }

        async function testEventSequence() {
            const results = document.getElementById('sequence-results');
            results.innerHTML = '<p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏...</p>';

            let html = '<h3>–¢–µ—Å—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:</h3>';

            try {
                // –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                let state = {
                    location: "main",
                    turn: 0,
                    seenIds: [],
                    cooldowns: {},
                    stats: {
                        hp: 20,
                        damage: 3,
                        fame: 0,
                        gold: 10,
                        items: []
                    }
                };

                html += '<h4>üìç –®–∞–≥ 1: –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ</h4>';
                html += `<pre>${JSON.stringify(state, null, 2)}</pre>`;

                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–µ—Ä–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ
                let response = await fetch('/api/next.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        state
                    })
                });
                let result = await response.json();

                if (result.success) {
                    html += '<h4>üìç –®–∞–≥ 2: –ü–µ—Ä–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ –ø—Ä–æ–ª–æ–≥–∞</h4>';
                    html += `<div class="success">
                        <strong>${result.data.event.title}</strong><br>
                        ID: ${result.data.event.id}<br>
                        Choices: ${result.data.event.choices.map(c => c.label).join(', ')}
                    </div>`;

                    state = result.data.state;

                    // –ò–º–∏—Ç–∏—Ä—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
                    for (let i = 0; i < 3; i++) {
                        state.turn++;
                        if (!state.seenIds.includes(result.data.event.id)) {
                            state.seenIds.push(result.data.event.id);
                        }

                        response = await fetch('/api/next.php', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                state
                            })
                        });
                        result = await response.json();

                        if (result.success) {
                            html += `<div class="success">
                                <strong>–•–æ–¥ ${state.turn}:</strong> ${result.data.event.title} (${result.data.event.id})
                            </div>`;
                            state = result.data.state;
                        } else {
                            break;
                        }
                    }

                    html += '<h4>üìç –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:</h4>';
                    html += `<pre>${JSON.stringify(state, null, 2)}</pre>`;

                } else {
                    html += `<div class="error">–û—à–∏–±–∫–∞: ${result.error}</div>`;
                }

            } catch (error) {
                html += `<div class="error">Network Error: ${error.message}</div>`;
            }

            results.innerHTML = html;
        }
    </script>
</body>

</html>