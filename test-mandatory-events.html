<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Mandatory Events</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .success {
            background: #d4edda;
            border-color: #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            border-color: #f5c6cb;
        }
        
        .info {
            background: #d1ecf1;
            border-color: #bee5eb;
        }
        
        .warning {
            background: #fff3cd;
            border-color: #ffeaa7;
        }
        
        button {
            padding: 10px 15px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
        
        .event-result {
            background: #f8f9fa;
            padding: 10px;
            margin: 5px 0;
            border-radius: 3px;
            border-left: 4px solid #007bff;
        }
        
        .mandatory-event {
            border-left-color: #dc3545;
        }
        
        .priority-event {
            border-left-color: #ffc107;
        }
        
        .normal-event {
            border-left-color: #28a745;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin: 10px 0;
        }
        
        .stat {
            background: #e9ecef;
            padding: 5px 10px;
            border-radius: 3px;
        }
    </style>
</head>

<body>
    <h1>‚è∞ Test Mandatory Events System</h1>

    <div class="test-section">
        <h2>üìã Rent Event Test</h2>
        <button onclick="testRentEvent()">Test Rent Event (every 10 turns)</button>
        <div id="rent-results"></div>
    </div>

    <div class="test-section">
        <h2>üîÑ Turn Sequence Test</h2>
        <button onclick="testTurnSequence()">Test 25 Turns Sequence</button>
        <div id="sequence-results"></div>
    </div>

    <div class="test-section">
        <h2>üí∞ Debt System Test</h2>
        <button onclick="testDebtSystem()">Test Debt System</button>
        <div id="debt-results"></div>
    </div>

    <div class="test-section">
        <h2>üöÄ Full Game Test</h2>
        <p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã —Å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º–∏ —Å–æ–±—ã—Ç–∏—è–º–∏:</p>
        <button onclick="window.open('/public/index.html', '_blank')">üéØ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
    </div>

    <script>
        async function testRentEvent() {
            const results = document.getElementById('rent-results');
            results.innerHTML = '<p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –∞—Ä–µ–Ω–¥—ã...</p>';

            let html = '<h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤ –∞—Ä–µ–Ω–¥—ã:</h3>';

            try {
                // –¢–µ—Å—Ç–∏—Ä—É–µ–º –Ω–∞ 10-–º —Ö–æ–¥—É (–¥–æ–ª–∂–Ω–æ —Å—Ä–∞–±–æ—Ç–∞—Ç—å)
                const state10 = {
                    location: "village",
                    turn: 10,
                    seenIds: [],
                    cooldowns: {},
                    stats: {
                        hp: 20,
                        damage: 3,
                        fame: 0,
                        gold: 10,
                        debt: 0,
                        items: []
                    }
                };

                const response10 = await fetch('/api/next.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        state: state10
                    })
                });

                const result10 = await response10.json();

                if (result10.success) {
                    const event = result10.data.event;
                    const meta = event.meta || {};

                    html += `<div class="event-result ${meta.was_mandatory ? 'mandatory-event' : 'normal-event'}">
                        <h4>${meta.was_mandatory ? '‚è∞ Mandatory Event' : 'üìã Normal Event'}</h4>
                        <strong>${event.title}</strong><br>
                        <em>ID: ${event.id}</em><br>
                        <strong>Selection Method:</strong> ${meta.selection_method}<br>
                        <strong>Effects:</strong> ${JSON.stringify(event.effects)}<br>
                        <small>Turn: ${state10.turn} | Location: ${state10.location}</small>
                    </div>`;
                }

                // –¢–µ—Å—Ç–∏—Ä—É–µ–º –Ω–∞ 5-–º —Ö–æ–¥—É (–Ω–µ –¥–æ–ª–∂–Ω–æ —Å—Ä–∞–±–æ—Ç–∞—Ç—å)
                const state5 = {
                    location: "village",
                    turn: 5,
                    seenIds: [],
                    cooldowns: {},
                    stats: {
                        hp: 20,
                        damage: 3,
                        fame: 0,
                        gold: 10,
                        debt: 0,
                        items: []
                    }
                };

                const response5 = await fetch('/api/next.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        state: state5
                    })
                });

                const result5 = await response5.json();

                if (result5.success) {
                    const event = result5.data.event;
                    const meta = event.meta || {};

                    html += `<div class="event-result ${meta.was_mandatory ? 'mandatory-event' : 'normal-event'}">
                        <h4>${meta.was_mandatory ? '‚è∞ Mandatory Event' : 'üìã Normal Event'}</h4>
                        <strong>${event.title}</strong><br>
                        <em>ID: ${event.id}</em><br>
                        <strong>Selection Method:</strong> ${meta.selection_method}<br>
                        <small>Turn: ${state5.turn} | Location: ${state5.location}</small>
                    </div>`;
                }

            } catch (error) {
                html += `<div class="error">‚ùå Error: ${error.message}</div>`;
            }

            results.innerHTML = html;
        }

        async function testTurnSequence() {
            const results = document.getElementById('sequence-results');
            results.innerHTML = '<p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Ö–æ–¥–æ–≤...</p>';

            let html = '<h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã 25 —Ö–æ–¥–æ–≤:</h3>';

            const mandatoryEvents = [];
            const normalEvents = [];

            for (let turn = 1; turn <= 25; turn++) {
                try {
                    const state = {
                        location: "village",
                        turn: turn,
                        seenIds: [],
                        cooldowns: {},
                        stats: {
                            hp: 20,
                            damage: 3,
                            fame: 0,
                            gold: 10,
                            debt: 0,
                            items: []
                        }
                    };

                    const response = await fetch('/api/next.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            state
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        const event = result.data.event;
                        const meta = event.meta || {};

                        if (meta.was_mandatory) {
                            mandatoryEvents.push({
                                turn,
                                event: event.title,
                                id: event.id
                            });
                        } else {
                            normalEvents.push({
                                turn,
                                event: event.title,
                                id: event.id
                            });
                        }

                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–∞–∂–¥—ã–µ 5 —Ö–æ–¥–æ–≤ –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏
                        if (turn % 5 === 0 || meta.was_mandatory) {
                            html += `<div class="event-result ${meta.was_mandatory ? 'mandatory-event' : 'normal-event'}">
                                <strong>Turn ${turn}:</strong> ${event.title} 
                                ${meta.was_mandatory ? '(‚è∞ Mandatory)' : '(üìã Normal)'}
                            </div>`;
                        }
                    }

                } catch (error) {
                    html += `<div class="error">Turn ${turn} failed: ${error.message}</div>`;
                }
            }

            html += `<div class="info">
                <h4>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</h4>
                <p>Mandatory Events: ${mandatoryEvents.length} (${(mandatoryEvents.length/25*100).toFixed(1)}%)</p>
                <p>Normal Events: ${normalEvents.length} (${(normalEvents.length/25*100).toFixed(1)}%)</p>
                <p>Mandatory Events at turns: ${mandatoryEvents.map(e => e.turn).join(', ')}</p>
            </div>`;

            results.innerHTML = html;
        }

        async function testDebtSystem() {
            const results = document.getElementById('debt-results');
            results.innerHTML = '<p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –¥–æ–ª–≥–æ–≤...</p>';

            let html = '<h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤ –¥–æ–ª–≥–æ–≤:</h3>';

            try {
                // –¢–µ—Å—Ç —Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º –∑–æ–ª–æ—Ç–æ–º
                const poorState = {
                    location: "village",
                    turn: 10,
                    seenIds: [],
                    cooldowns: {},
                    stats: {
                        hp: 20,
                        damage: 3,
                        fame: 0,
                        gold: 2,
                        debt: 0,
                        items: []
                    }
                };

                html += '<h4>üí∞ –¢–µ—Å—Ç —Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º –∑–æ–ª–æ—Ç–æ–º (2 –∑–æ–ª–æ—Ç–∞, –Ω—É–∂–Ω—ã 5):</h4>';
                html += `<div class="warning">
                    <strong>–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ:</strong> –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–æ–ª–æ—Ç–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã –∞—Ä–µ–Ω–¥—ã!<br>
                    <em>–°–∏—Å—Ç–µ–º–∞ –¥–æ–ª–∂–Ω–∞ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –≤–∑—è—Ç—å –≤ –¥–æ–ª–≥</em>
                </div>`;

                // –¢–µ—Å—Ç —Å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º –∑–æ–ª–æ—Ç–æ–º
                const richState = {
                    location: "village",
                    turn: 20,
                    seenIds: [],
                    cooldowns: {},
                    stats: {
                        hp: 20,
                        damage: 3,
                        fame: 0,
                        gold: 15,
                        debt: 0,
                        items: []
                    }
                };

                html += '<h4>üí∞ –¢–µ—Å—Ç —Å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º –∑–æ–ª–æ—Ç–æ–º (15 –∑–æ–ª–æ—Ç–∞):</h4>';
                html += `<div class="success">
                    <strong>–£—Å–ø–µ—Ö:</strong> –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–æ–ª–æ—Ç–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã –∞—Ä–µ–Ω–¥—ã<br>
                    <em>–î–æ–ª–≥ –Ω–µ –¥–æ–ª–∂–µ–Ω —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å—Å—è</em>
                </div>`;

                // –¢–µ—Å—Ç —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –¥–æ–ª–≥–æ–º
                const debtState = {
                    location: "village",
                    turn: 30,
                    seenIds: [],
                    cooldowns: {},
                    stats: {
                        hp: 20,
                        damage: 3,
                        fame: 0,
                        gold: 1,
                        debt: 3,
                        items: []
                    }
                };

                html += '<h4>üìã –¢–µ—Å—Ç —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –¥–æ–ª–≥–æ–º (1 –∑–æ–ª–æ—Ç–æ, –¥–æ–ª–≥ 3):</h4>';
                html += `<div class="warning">
                    <strong>–°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –¥–æ–ª–≥:</strong> 3 –∑–æ–ª–æ—Ç–∞<br>
                    <em>–ù–æ–≤—ã–π –¥–æ–ª–≥ –¥–æ–ª–∂–µ–Ω –¥–æ–±–∞–≤–∏—Ç—å—Å—è –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É</em>
                </div>`;

            } catch (error) {
                html += `<div class="error">‚ùå Error: ${error.message}</div>`;
            }

            results.innerHTML = html;
        }
    </script>
</body>

</html>